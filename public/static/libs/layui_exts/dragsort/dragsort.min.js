layui.define(["jquery"],function(t){var c,e=layui.$;(c=e).fn.dragsort=function(t){if("destroy"!=t){var d=c.extend({},c.fn.dragsort.defaults,t),l=[],n=null,s=null;return this.each(function(t,e){e={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:e=c(e).is("table")&&1==c(e).children().size()&&c(e).children().is("tbody")?c(e).children().get(0):e,init:function(){d.tagName=""==d.tagName?0==c(this.container).children().size()?"li":c(this.container).children().get(0).tagName.toLowerCase():d.tagName,""==d.itemSelector&&(d.itemSelector=d.tagName),""==d.dragSelector&&(d.dragSelector=d.tagName),""==d.placeHolderTemplate&&(d.placeHolderTemplate="<"+d.tagName+">&nbsp;</"+d.tagName+">"),c(this.container).attr("data-listidx",t).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var t=l[c(this).attr("data-listidx")];c(t.container).unbind("mousedown",t.grabItem).unbind("dragsort-uninit"),t.styleDragHandlers(!1)},getItems:function(){return c(this.container).children(d.itemSelector)},styleDragHandlers:function(t){this.getItems().map(function(){return c(this).is(d.dragSelector)?this:c(this).find(d.dragSelector).get()}).css("cursor",t?"pointer":"")},grabItem:function(t){var e=l[c(this).attr("data-listidx")],r=c(t.target).closest("[data-listidx] > "+d.tagName).get(0),o=0<e.getItems().filter(function(){return this==r}).size();if(!(1!=t.which||c(t.target).is(d.dragSelectorExclude)||0<c(t.target).closest(d.dragSelectorExclude).size())&&o){t.preventDefault();for(var a=t.target;!c(a).is(d.dragSelector);){if(a==this)return;a=a.parentNode}c(a).attr("data-cursor",c(a).css("cursor")),c(a).css("cursor","move");var i=this,n=function(){e.dragStart.call(i,t),c(e.container).unbind("mousemove",n)};c(e.container).mousemove(n).mouseup(function(){c(e.container).unbind("mousemove",n),c(a).css("cursor",c(a).attr("data-cursor"))})}},dragStart:function(t){null!=n&&null!=n.draggedItem&&n.dropItem(),(n=l[c(this).attr("data-listidx")]).draggedItem=c(t.target).closest("[data-listidx] > "+d.tagName),n.draggedItem.attr("data-origpos",c(this).attr("data-listidx")+"-"+c(n.container).children().index(n.draggedItem));var e=parseInt(n.draggedItem.css("marginTop")),r=parseInt(n.draggedItem.css("marginLeft"));n.offset=n.draggedItem.offset(),n.offset.top=t.pageY-n.offset.top+(isNaN(e)?0:e)-1,n.offset.left=t.pageX-n.offset.left+(isNaN(r)?0:r)-1,d.dragBetween||(o=0==c(n.container).outerHeight()?Math.max(1,Math.round(.5+n.getItems().size()*n.draggedItem.outerWidth()/c(n.container).outerWidth()))*n.draggedItem.outerHeight():c(n.container).outerHeight(),n.offsetLimit=c(n.container).offset(),n.offsetLimit.right=n.offsetLimit.left+c(n.container).outerWidth()-n.draggedItem.outerWidth(),n.offsetLimit.bottom=n.offsetLimit.top+o-n.draggedItem.outerHeight());var r=n.draggedItem.height(),o=n.draggedItem.width();"tr"==d.tagName?(n.draggedItem.children().each(function(){c(this).width(c(this).width())}),n.placeHolderItem=n.draggedItem.clone().attr("data-placeholder",!0),n.draggedItem.after(n.placeHolderItem),n.placeHolderItem.children().each(function(){c(this).css({borderWidth:0,width:c(this).width()+1,height:c(this).height()+1}).html("&nbsp;")})):(n.draggedItem.after(d.placeHolderTemplate),n.placeHolderItem=n.draggedItem.next().css({height:r,width:o}).attr("data-placeholder",!0)),"td"==d.tagName&&(a=n.draggedItem.closest("table").get(0),c("<table id='"+a.id+"' style='border-width: 0px;' class='dragSortItem "+a.className+"'><tr></tr></table>").appendTo("body").children().append(n.draggedItem));var a=n.draggedItem.attr("style");n.draggedItem.attr("data-origstyle",a||""),n.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:r,width:o}),n.scroll={moveX:0,moveY:0,maxX:c(document).width()-c(window).width(),maxY:c(document).height()-c(window).height()},n.scroll.scrollY=window.setInterval(function(){var t;d.scrollContainer==window?(t=c(d.scrollContainer).scrollTop(),(0<n.scroll.moveY&&t<n.scroll.maxY||n.scroll.moveY<0&&0<t)&&(c(d.scrollContainer).scrollTop(t+n.scroll.moveY),n.draggedItem.css("top",n.draggedItem.offset().top+n.scroll.moveY+1))):c(d.scrollContainer).scrollTop(c(d.scrollContainer).scrollTop()+n.scroll.moveY)},10),n.scroll.scrollX=window.setInterval(function(){var t;d.scrollContainer==window?(t=c(d.scrollContainer).scrollLeft(),(0<n.scroll.moveX&&t<n.scroll.maxX||n.scroll.moveX<0&&0<t)&&(c(d.scrollContainer).scrollLeft(t+n.scroll.moveX),n.draggedItem.css("left",n.draggedItem.offset().left+n.scroll.moveX+1))):c(d.scrollContainer).scrollLeft(c(d.scrollContainer).scrollLeft()+n.scroll.moveX)},10),c(l).each(function(t,e){e.createDropTargets(),e.buildPositionTable()}),n.setPos(t.pageX,t.pageY),c(document).bind("mousemove",n.swapItems),c(document).bind("mouseup",n.dropItem),d.scrollContainer!=window&&c(window).bind("wheel",n.wheel)},setPos:function(t,e){var r=e-this.offset.top,o=t-this.offset.left;d.dragBetween||(r=Math.min(this.offsetLimit.bottom,Math.max(r,this.offsetLimit.top)),o=Math.min(this.offsetLimit.right,Math.max(o,this.offsetLimit.left)));var a,i=this.draggedItem.offsetParent().not("body").offset();null!=i&&(r-=i.top,o-=i.left),t=d.scrollContainer==window?(e-=c(window).scrollTop(),t-=c(window).scrollLeft(),e=Math.max(0,e-c(window).height()+5)+Math.min(0,e-5),Math.max(0,t-c(window).width()+5)+Math.min(0,t-5)):(i=(a=c(d.scrollContainer)).offset(),e=Math.max(0,e-a.height()-i.top)+Math.min(0,e-i.top),Math.max(0,t-a.width()-i.left)+Math.min(0,t-i.left)),n.scroll.moveX=0==t?0:t*d.scrollSpeed/Math.abs(t),n.scroll.moveY=0==e?0:e*d.scrollSpeed/Math.abs(e),this.draggedItem.css({top:r,left:o})},wheel:function(t){var e,r;n&&d.scrollContainer!=window&&(r=(e=c(d.scrollContainer)).offset(),(t=t.originalEvent).clientX>r.left&&t.clientX<r.left+e.width()&&t.clientY>r.top&&t.clientY<r.top+e.height()&&(r=(0==t.deltaMode?1:10)*t.deltaY,e.scrollTop(e.scrollTop()+r),t.preventDefault()))},buildPositionTable:function(){var r=[];this.getItems().not([n.draggedItem[0],n.placeHolderItem[0]]).each(function(t){var e=c(this).offset();e.right=e.left+c(this).outerWidth(),e.bottom=e.top+c(this).outerHeight(),e.elm=this,r[t]=e}),this.pos=r},dropItem:function(){if(null!=n.draggedItem){var t,e=n.draggedItem.attr("data-origstyle");return n.draggedItem.attr("style",e),""==e&&n.draggedItem.removeAttr("style"),n.draggedItem.removeAttr("data-origstyle"),n.styleDragHandlers(!0),n.placeHolderItem.before(n.draggedItem),n.placeHolderItem.remove(),c("[data-droptarget], .dragSortItem").remove(),window.clearInterval(n.scroll.scrollY),window.clearInterval(n.scroll.scrollX),n.draggedItem.attr("data-origpos")!=c(l).index(n)+"-"+c(n.container).children().index(n.draggedItem)&&0==d.dragEnd.apply(n.draggedItem)&&(t=n.draggedItem.attr("data-origpos").split("-"),0<(e=c(l[t[0]].container).children().not(n.draggedItem).eq(t[1])).size()?e.before(n.draggedItem):0==t[1]?c(l[t[0]].container).prepend(n.draggedItem):c(l[t[0]].container).append(n.draggedItem)),n.draggedItem.removeAttr("data-origpos"),n.draggedItem=null,c(document).unbind("mousemove",n.swapItems),c(document).unbind("mouseup",n.dropItem),d.scrollContainer!=window&&c(window).unbind("wheel",n.wheel),!1}},swapItems:function(t){if(null==n.draggedItem)return!1;n.setPos(t.pageX,t.pageY);for(var e=n.findPos(t.pageX,t.pageY),r=n,o=0;-1==e&&d.dragBetween&&o<l.length;o++)e=l[o].findPos(t.pageX,t.pageY),r=l[o];if(-1==e)return!1;function a(){return c(r.container).children().not(r.draggedItem)}var i=a().not(d.itemSelector).each(function(t){this.idx=a().index(this)});return null==s||s.top>n.draggedItem.offset().top||s.left>n.draggedItem.offset().left?c(r.pos[e].elm).before(n.placeHolderItem):c(r.pos[e].elm).after(n.placeHolderItem),i.each(function(){var t=a().eq(this.idx).get(0);this!=t&&a().index(this)<this.idx?c(this).insertAfter(t):this!=t&&c(this).insertBefore(t)}),c(l).each(function(t,e){e.createDropTargets(),e.buildPositionTable()}),s=n.draggedItem.offset(),!1},findPos:function(t,e){for(var r=0;r<this.pos.length;r++)if(this.pos[r].left<t&&this.pos[r].right>t&&this.pos[r].top<e&&this.pos[r].bottom>e)return r;return-1},createDropTargets:function(){d.dragBetween&&c(l).each(function(){var t=c(this.container).find("[data-placeholder]"),e=c(this.container).find("[data-droptarget]");0<t.size()&&0<e.size()?e.remove():0==t.size()&&0==e.size()&&("td"==d.tagName?c(d.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):c(this.container).append(n.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),n.placeHolderItem.attr("data-placeholder",!0))})}};e.init(),l.push(e)}),this}c(this.selector).trigger("dragsort-uninit")},c.fn.dragsort.defaults={tagName:"",itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5},t("dragsort",{})});